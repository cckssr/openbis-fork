/*
 *  Copyright ETH 2025 ZÃ¼rich, Scientific IT Services
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *       http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *
 */


tasks.register('clean', Delete) {
    delete 'build'
}

tasks.register('api', Copy) {
    dependsOn([project(':api-openbis-java').tasks.release,
               project(':api-openbis-java').tasks.releaseDependenciesIncluded,
               project(':api-openbis-javascript').tasks.release,
               project(':api-openbis-python3-pybis').tasks.release
    ])

    from project(':api-openbis-java').tasks.release.archiveFile
    from project(':api-openbis-java').tasks.releaseDependenciesIncluded.archiveFile
    from project(':api-openbis-javascript').tasks.release.archiveFile
    from project(':api-openbis-python3-pybis').tasks.release.archiveFile

    into file('build/api')
}

tasks.register('app', Copy) {
    dependsOn([project(':app-openbis-command-line').tasks.release,
               project(':app-openbis-drive').tasks.release,
               project(':app-openbis-installer').tasks.release
    ])

    from project(':app-openbis-command-line').tasks.release.archiveFile
    from project(':app-openbis-drive').tasks.release.archiveFile
    from project(':app-openbis-installer').tasks.release.archiveFile
    into file('build/app')
}


tasks.register('javadoc', Copy) {
    dependsOn( ':server-application-server:javadocTar',
            ':server-application-server:dynamicApiJavadocTar',
            ':server-original-data-store:javadocTar',
            ':server-original-data-store:dropboxJavadocTar'
    )
    from project(':server-application-server').tasks.javadocTar.archiveFile
    from project(':server-application-server').tasks.dynamicApiJavadocTar.archiveFile
    from project(':server-original-data-store').tasks.javadocTar.archiveFile
    from project(':server-original-data-store').tasks.dropboxJavadocTar.archiveFile
    into file('build/javadoc')
}


tasks.register('buildRelease', Tar) {
//tasks.register('release', Tar) {
    // API
    dependsOn([project(':api-openbis-java').tasks.release,
               project(':api-openbis-java').tasks.releaseDependenciesIncluded,
               project(':api-openbis-javascript').tasks.release,
               project(':api-openbis-python3-pybis').tasks.release
    ])
    // APP
    dependsOn([project(':app-openbis-command-line').tasks.release,
               project(':app-openbis-drive').tasks.release,
               project(':app-openbis-installer').tasks.release
    ])
    //JAVADOC
    dependsOn([':server-application-server:javadocTar',
               ':server-application-server:dynamicApiJavadocTar',
               ':server-original-data-store:javadocTar',
               ':server-original-data-store:dropboxJavadocTar'
    ])

    def version = project.ext.versionNumber

    archiveFileName = 'openbis-release-' + version + '.tar.gz'
    destinationDirectory = layout.buildDirectory.dir(".")


    from([project(':api-openbis-java').tasks.release.archiveFile,
          project(':api-openbis-java').tasks.releaseDependenciesIncluded.archiveFile,
          project(':api-openbis-javascript').tasks.release.archiveFile,
          project(':api-openbis-python3-pybis').tasks.release.archiveFile
    ]) {
        into 'api'
    }

    from([project(':app-openbis-command-line').tasks.release.archiveFile,
          project(':app-openbis-installer').tasks.release.archiveFile,
          project(':app-openbis-drive').tasks.release.archiveFile
    ]) {
        into 'app'
    }

    from([project(':server-application-server').tasks.javadocTar.archiveFile,
          project(':server-application-server').tasks.dynamicApiJavadocTar.archiveFile,
          project(':server-original-data-store').tasks.javadocTar.archiveFile,
          project(':server-original-data-store').tasks.dropboxJavadocTar.archiveFile
    ]) {
        into 'javadoc'
    }
}



def execute_working_dir(command, arguments, working_dir) {
    new ByteArrayOutputStream().withStream { os ->
        print "execute: ${command}"
        arguments.collect({print " ${it}"})
        println ''
        def result = exec {
            executable = command
            args = arguments
            standardOutput = os
        }
        return os.toString().split('\n')
    }
}

def calculateBuildInfo() {

    def gitlogoutput = execute_working_dir('git', ['log', '-1', '--format=%at'], '../' + project.name)
    project.ext.revisionNumber = Integer.parseInt(gitlogoutput[0])
    def tag = 'git tag -l --points-at HEAD'.execute().text.trim()
    if (tag == null || tag.isEmpty() || tag.contains('pybis')) {
        project.ext.versionNumber = 'SNAPSHOT'
    } else {
        project.ext.versionNumber = tag
    }
}

calculateBuildInfo()
